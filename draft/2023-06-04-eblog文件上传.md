---
layout: post
title: "eblog镜像的制作"
tags: [eblog,docker]
excerpt_separator: <!--more-->
---

开发了一个功能简洁、部署方便的个人博客系统 - eblog，详情见：<a href="https://leanfish2011.github.io/eblog-resource" target="_blank">eblog</a>

可以看到eblog由多个服务组成，这么多服务如何做到一键部署的？这么多镜像如何生成的？本文将为大家揭秘快速部署相关的问题。

# 快速部署
针对多服务的部署，自然最优的方案是docker，docker介绍见：<a href="https://leanfish2011.github.io/2023-05-03/%E5%AE%B9%E5%99%A8%E5%8C%96%E6%8A%80%E6%9C%AF%E7%9A%84%E4%BD%BF%E7%94%A8%E5%92%8C%E4%BC%98%E7%BC%BA%E7%82%B9" target="_blank">容器化技术的使用和优缺点</a>

将各个服务做成镜像，将运行环境等都集成到镜像中，方便各处部署和维护。那么这么多镜像如何组织起来？有两种方案：
- docker compose
- shell脚本

docker compose需要在服务器上额外安装，个人用的是1核2G的云服务器，不适合安装太多东西，另外docker compose不够灵活，而shell可根据项目情况获取需要的数据，可以自行定义各个步骤，就使用了通用的shell脚本。

eblog部署脚本见：<a href="https://github.com/leanfish2011/eblog-resource/blob/main/deploy/all_in_one/deploy.sh" target="_blank">eblog部署shell脚本</a>

镜像包单独提供。

脚本分为下面几个部分：
- 全局变量
- 全局操作
- 各个服务的部署

## 全局变量
整个项目镜像包名称、各个服务对应的镜像名称、挂载目录。这里填写各个服务制作生成的镜像名称，以及各个镜像生成的总的镜像包。如果有新的镜像，这些镜像名称需要替换。

还有指明挂载目录，这是宿主机上的位置，用于存储容器内的文件。

## 全局操作
生成项目需要的全局密码、服务器IP、加载镜像。项目用到mariadb，需要给mariadb设置密码，这里随机生成密码，同时各个连接mariadb的服务需要填写这个密码。部分服务需要用到服务器的IP。加载镜像使用了docker原始的命令：``docker load -i``。

## 各个服务的部署
按照依赖关系，即是：先启动基础服务、再执行初始化，最后启动后端服务和前端服务，依次部署各个服务。

| 类别 | 名称 | 作用 |
| --------- | ------------ | ------------------------- |
| 基础镜像   | portainer镜像 | 提供镜像、容器等管理服务      |
| 基础镜像   | mariadb镜像   | 提供mariadb服务            |
| 基础镜像   | ngxin镜像     | 提供ngxin服务              |
| 初始化镜像 | sql镜像       | 建库建表，一般只执行一次      |
| 后端镜像   | java镜像      | 博客后端服务                |
| 前端镜像   | 静态文件镜像   | 前端界面                    |

下面详细讲解服务启动命令：
1. 容器的启动也是使用原生的docker命令：``docker run``
2. ``-d``，使容器在后台运行
3. ``--net=host``，网络模式使用host，即是使用同宿主机在同一个网络
4. ``-v``，即是目录挂载，将容器内的文件挂载在宿主机上，实现了容器和宿主机的文件读写
5. ``--name``，容器的名称
6. ``-e``，环境变量，容器内的服务会读取这个变量
7. 最后是使用的镜像名称
8. 脚本中会看到``sleep 1m``命令，作用是担心上一步的服务还未完全启动，而下一步的服务又依赖这个服务，所以停顿1分钟之后再启动下一步服务。例如mariadb初始化服务需要等mariadb启动后才能执行。

在Linux终端上输入命令``./deploy.sh``，即会按照脚本内容顺序执行命令，完成整个项目的启动。

# 镜像制作
镜像分为三类：
- 项目依赖的镜像。指为了制作项目镜像，需要以一些已有的镜像作为基础，这些镜像从docker hub拉取。
- 项目可直接使用的镜像。主要是指基础镜像，拉取后直接使用。
- 项目的镜像。项目编排及运行需要的镜像。

## mariadb镜像
属可直接使用的镜像，从docker hub拉取即可，也可以打上tag，记录版本、拉取时间等。
```
# 构建mariadb基础镜像
sudo docker pull mariadb:latest
sudo docker tag mariadb:latest mariadb:20200329_204923
```

类似的镜像有：redis、mongo等，拉取后直接启动就能连接服务使用。

## sql脚本镜像
用于连接mariadb，执行sql语句，首先需要以mysql-client为基础，先拉取这个镜像
```
# 构建mariadb初始化基础镜像
# 镜像来源：https://registry.hub.docker.com/r/arey/mysql-client
sudo docker pull arey/mysql-client:latest
sudo docker tag arey/mysql-client:latest mysql-client:20210809_194301
```

Dockerfile需要指明依赖的基础镜像，再将sql脚本和执行sql的shell脚本拷贝到镜像中，最后执行shell。内容如下：
```
# 使用mysql-client镜像
FROM mysql-client:20210809_194301

# 设置时区
ENV TZ=Asia/Shanghai

# 将sql语句、shell脚本拷贝到scripts文件夹下
ADD *.sql /scripts/
ADD init_db.sh /scripts/

# 执行shell，覆盖父类ENTRYPOINT
ENTRYPOINT ["./scripts/init_db.sh"]
```

sql文件即是建库建表的语句。init_db.sh主要是连接mariadb执行sql。内容见：<a href="https://github.com/leanfish2011/eblog-post/blob/main/docker/mariadb/init_db.sh" target="_blank">init_db.sh</a>

核心语句是：
```
mysql -uroot -p$MYSQL_ROOT_PASSWORD -h127.0.0.1 --default-character-set=utf8mb4 -e "source $file_name;"
```
## nginx镜像


## 前端镜像

## 后端服务镜像

## 项目的镜像制作目录
